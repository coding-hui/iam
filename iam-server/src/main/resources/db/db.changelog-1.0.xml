<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="2" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_tenant`
                ADD `login_type` tinyint NULL COMMENT '登录类型';
        </sql>
    </changeSet>

    <changeSet id="3" author="yuhui.liu">
        <sql>
            CREATE TABLE IF NOT EXISTS `iam_oauth2_registered_client`
            (
                `id`
                bigint
                AUTO_INCREMENT
                COMMENT
                '自增主键'
                PRIMARY
                KEY,
                `client_id`
                varchar
            (
                100
            ) NOT NULL,
                `client_id_issued_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
                `client_secret` varchar
            (
                200
            ) DEFAULT NULL,
                `client_secret_expires_at` timestamp NULL DEFAULT NULL,
                `client_name` varchar
            (
                200
            ) NOT NULL,
                `client_authentication_methods` varchar
            (
                1000
            ) NOT NULL,
                `authorization_grant_types` varchar
            (
                1000
            ) NOT NULL,
                `redirect_uris` varchar
            (
                1000
            ) DEFAULT NULL,
                `scopes` varchar
            (
                1000
            ) NOT NULL,
                `client_settings` varchar
            (
                2000
            ) NOT NULL,
                `token_settings` varchar
            (
                2000
            ) NOT NULL,
                `create_time` datetime DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
                `created_by` varchar
            (
                64
            ) NULL COMMENT '创建者',
                `update_time` datetime DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
                `updated_by` varchar
            (
                64
            ) NULL COMMENT '修改者'
                ) ENGINE = InnoDB
                DEFAULT CHARSET = utf8 COMMENT ='客户端表';
        </sql>
    </changeSet>

    <changeSet id="4" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_user`
                ADD `login_count` int NOT NULL DEFAULT 0 COMMENT '登录次数' AFTER `last_login_time`;
        </sql>
    </changeSet>

    <changeSet id="5" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_user`
                ADD `name` varchar(360) NOT NULL DEFAULT '' COMMENT '姓名' AFTER `tenant_id`;
            ALTER TABLE `iam_user`
                ADD `company` varchar(20) NOT NULL DEFAULT '' COMMENT '公司' AFTER `country`;
            ALTER TABLE `iam_user`
                ADD `address` varchar(64) NOT NULL DEFAULT '' COMMENT '住址' AFTER `company`;
            ALTER TABLE `iam_user`
                ADD `province` varchar(20) NOT NULL DEFAULT '' COMMENT '省份' AFTER `address`;
            ALTER TABLE `iam_user`
                ADD `city` varchar(20) NOT NULL DEFAULT '' COMMENT '城市' AFTER `province`;
            ALTER TABLE `iam_user`
                ADD `street_address` varchar(64) NOT NULL DEFAULT '' COMMENT '街道地址' AFTER `city`;
            ALTER TABLE `iam_user`
                ADD `postal_code` char(6) NOT NULL DEFAULT '' COMMENT '邮政编码' AFTER `street_address`;
            ALTER TABLE `iam_user`
                ADD `external_id` varchar(64) NOT NULL DEFAULT '' COMMENT '原系统ID' AFTER `postal_code`;
            ALTER TABLE `iam_user` DROP COLUMN `infos`;
        </sql>
    </changeSet>

    <changeSet id="6" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_group`
                ADD `group_code` varchar(64) NOT NULL DEFAULT '' COMMENT '唯一标识' AFTER `tenant_id`;
            ALTER TABLE `iam_group`
                ADD `description` varchar(255) NOT NULL DEFAULT '' COMMENT '描述备注' AFTER `group_name`;
        </sql>
    </changeSet>

    <changeSet id="7" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_group` DROP INDEX `iam_group_tenant_id_group_name_uindex`;
            ALTER TABLE `iam_group` DROP INDEX `iam_group_group_name_index`;
            ALTER TABLE `iam_group`
                ADD UNIQUE `iam_group_tenant_id_group_code_uindex`(`tenant_id`, `group_code`);
            ALTER TABLE `iam_group`
                ADD INDEX `iam_group_group_code_index`(`group_code`);
        </sql>
    </changeSet>

    <changeSet id="8" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_user` DROP COLUMN `user_id`;
            ALTER TABLE `iam_user` DROP COLUMN `name`;
            ALTER TABLE `iam_user` DROP COLUMN `username`;
            ALTER TABLE `iam_user` DROP COLUMN `nick_name`;
            ALTER TABLE `iam_user` DROP COLUMN `avatar`;
            ALTER TABLE `iam_user` DROP COLUMN `birthday`;
            ALTER TABLE `iam_user` DROP COLUMN `gender`;
            ALTER TABLE `iam_user` DROP COLUMN `email`;
            ALTER TABLE `iam_user` DROP COLUMN `phone`;
            ALTER TABLE `iam_user` DROP COLUMN `user_type`;
            ALTER TABLE `iam_user` DROP COLUMN `country`;
            ALTER TABLE `iam_user` DROP COLUMN `company`;
            ALTER TABLE `iam_user` DROP COLUMN `address`;
            ALTER TABLE `iam_user` DROP COLUMN `province`;
            ALTER TABLE `iam_user` DROP COLUMN `city`;
            ALTER TABLE `iam_user` DROP COLUMN `street_address`;
            ALTER TABLE `iam_user` DROP COLUMN `postal_code`;

            CREATE TABLE IF NOT EXISTS `iam_user_profile`
            (
                `user_id`
                BIGINT
                AUTO_INCREMENT
                COMMENT
                '用户Id'
                PRIMARY
                KEY,
                `tenant_id`
                VARCHAR
            (
                64
            ) NOT NULL COMMENT '租户',
                `username` VARCHAR
            (
                360
            ) NOT NULL DEFAULT '' COMMENT '登录账号',
                `nick_name` VARCHAR
            (
                360
            ) NOT NULL DEFAULT '' COMMENT '昵称别名',
                `avatar` VARCHAR
            (
                1024
            ) NOT NULL DEFAULT '' COMMENT '头像',
                `birthday` datetime NULL COMMENT '生日',
                `gender` TINYINT NOT NULL DEFAULT 0 COMMENT '性别',
                `email` VARCHAR
            (
                64
            ) NOT NULL DEFAULT '' COMMENT '邮箱',
                `phone` VARCHAR
            (
                11
            ) NOT NULL DEFAULT '' COMMENT '电话',
                `country` VARCHAR
            (
                64
            ) NOT NULL DEFAULT '' COMMENT '国家',
                `company` VARCHAR
            (
                20
            ) NOT NULL DEFAULT '' COMMENT '公司',
                `address` VARCHAR
            (
                64
            ) NOT NULL DEFAULT '' COMMENT '住址',
                `province` VARCHAR
            (
                20
            ) NOT NULL DEFAULT '' COMMENT '省份',
                `city` VARCHAR
            (
                20
            ) NOT NULL DEFAULT '' COMMENT '城市',
                `street_address` VARCHAR
            (
                64
            ) NOT NULL DEFAULT '' COMMENT '街道地址',
                `postal_code` CHAR
            (
                6
            ) NOT NULL DEFAULT '' COMMENT '邮政编码',
                `create_time` datetime DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
                `created_by` VARCHAR
            (
                64
            ) NULL COMMENT '创建者',
                `update_time` datetime DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
                `updated_by` VARCHAR
            (
                64
            ) NULL COMMENT '修改者'
                ) ENGINE = INNODB DEFAULT CHARSET = utf8mb4 COMMENT = '用户信息表';
        </sql>
    </changeSet>

    <changeSet id="9" author="yuhui.liu">
        <sql>
            ALTER TABLE `iam_user` DROP COLUMN `external_id`;
            ALTER TABLE `iam_user_profile`
                ADD `name` varchar(360) NOT NULL DEFAULT '' COMMENT '姓名' AFTER `username`;
            ALTER TABLE `iam_user_profile`
                ADD `external_id` varchar(64) NOT NULL DEFAULT '' COMMENT '第三方系统Id' AFTER `username`;
        </sql>
    </changeSet>

</databaseChangeLog>